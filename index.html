<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HE-NMPC Electrolyzer Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c2461, #1e3799);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #4bcffa;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel h2 {
            color: #4bcffa;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #4bcffa;
            padding-bottom: 10px;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .sensor-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .sensor-item:hover {
            transform: translateY(-5px);
        }

        .sensor-value {
            font-size: 2em;
            font-weight: bold;
            color: #4bcffa;
            margin: 10px 0;
        }

        .sensor-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .bar-container {
            width: 30px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 10px auto;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #4bcffa, #0abde3);
            border-radius: 15px;
            transition: height 0.5s ease;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }

        .slider {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4bcffa;
            border-radius: 50%;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #4bcffa;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn:hover {
            background: #0abde3;
            transform: translateY(-2px);
        }

        .btn.stop {
            background: #ff6b6b;
        }

        .btn.stop:hover {
            background: #ee5a5a;
        }

        .btn.auto {
            background: #1dd1a1;
        }

        .btn.auto:hover {
            background: #10ac84;
        }

        .btn.manual {
            background: #feca57;
        }

        .btn.manual:hover {
            background: #ff9f43;
        }

        .data-display {
            font-size: 1.1em;
            margin: 5px 0;
        }

        .data-value {
            color: #4bcffa;
            font-weight: bold;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #ff6b6b;
            color: white;
            border-radius: 8px;
            font-weight: bold;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #1dd1a1;
        }

        .notification.warning {
            background: #feca57;
        }

        .notification.info {
            background: #4bcffa;
        }

        .efficiency-gauge {
            text-align: center;
            padding: 20px;
        }

        .gauge-value {
            font-size: 3em;
            font-weight: bold;
            color: #4bcffa;
            margin: 20px 0;
        }

        .mode-indicator {
            display: inline-block;
            padding: 5px 15px;
            background: #1dd1a1;
            border-radius: 20px;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .mode-indicator.manual {
            background: #feca57;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† HE-NMPC Electrolyzer Controller</h1>
            <p>Real-time Monitoring & Control Dashboard</p>
            <div class="status-bar">
                <div class="status-item">
                    <i class="fas fa-wifi"></i> Status: <span id="wifiStatus">CONNECTING...</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-microchip"></i> Controller: <span id="controllerType">HE-NMPC</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i> Last Update: <span id="lastUpdate">--:--:--</span>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <!-- Left Column - Sensors -->
            <div class="panel">
                <h2>üìä Real-time Sensors</h2>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <i class="fas fa-tint fa-2x"></i>
                        <div class="sensor-label">Water Level</div>
                        <div class="bar-container">
                            <div class="bar-fill" id="waterBar" style="height: 70%;"></div>
                        </div>
                        <div class="sensor-value" id="waterVal">70.0%</div>
                    </div>
                    
                    <div class="sensor-item">
                        <i class="fas fa-temperature-high fa-2x"></i>
                        <div class="sensor-label">Chamber Temp</div>
                        <div class="bar-container">
                            <div class="bar-fill" id="tempBar" style="height: 25%;"></div>
                        </div>
                        <div class="sensor-value" id="chamberVal">25.0¬∞C</div>
                    </div>
                    
                    <div class="sensor-item">
                        <i class="fas fa-wind fa-2x"></i>
                        <div class="sensor-label">Oxygen Level</div>
                        <div class="bar-container">
                            <div class="bar-fill" id="o2Bar" style="height: 40%;"></div>
                        </div>
                        <div class="sensor-value" id="oxyVal">40.0%</div>
                    </div>
                    
                    <div class="sensor-item">
                        <i class="fas fa-fire fa-2x"></i>
                        <div class="sensor-label">Hydrogen Level</div>
                        <div class="bar-container">
                            <div class="bar-fill" id="h2Bar" style="height: 30%;"></div>
                        </div>
                        <div class="sensor-value" id="h2Val">30.0%</div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Controls -->
            <div class="panel">
                <h2>üéõÔ∏è Control Panel</h2>
                <div class="controls">
                    <div class="control-group">
                        <h3>Production Rate Control</h3>
                        <div class="slider-container">
                            <span>0%</span>
                            <input type="range" min="0" max="100" value="30" class="slider" id="prodSlider">
                            <span>100%</span>
                        </div>
                        <div class="data-display">
                            Current Rate: <span class="data-value" id="prodValue">30%</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>System Mode</h3>
                        <div class="button-group">
                            <button class="btn auto" onclick="setMode('AUTO')">
                                <i class="fas fa-robot"></i> AUTO
                            </button>
                            <button class="btn manual" onclick="setMode('MANUAL')">
                                <i class="fas fa-user"></i> MANUAL
                            </button>
                        </div>
                        <div class="data-display">
                            Current Mode: <span class="data-value" id="currentMode">AUTO</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>System Control</h3>
                        <div class="button-group">
                            <button class="btn" onclick="startSystem()">
                                <i class="fas fa-play"></i> START
                            </button>
                            <button class="btn stop" onclick="stopSystem()">
                                <i class="fas fa-stop"></i> STOP
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>System Efficiency</h3>
                        <div class="efficiency-gauge">
                            <i class="fas fa-bolt fa-3x"></i>
                            <div class="gauge-value" id="efficiencyText">75.0%</div>
                            <div>Stack Efficiency</div>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Power System</h3>
                        <div class="data-display">
                            Battery Voltage: <span class="data-value" id="batteryV">12.2 V</span>
                        </div>
                        <div class="data-display">
                            Purity Level: <span class="data-value" id="purityLevel">99.7%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-exclamation-triangle"></i> <span id="notificationText">Test Message</span>
    </div>

    <script>
        // MQTT Configuration - USING PROPER MQTT.JS LIBRARY
        const MQTT_CONFIG = {
            broker: 'wss://broker.hivemq.com:8884/mqtt',
            topics: {
                data: 'electrolyzer/bill/data',
                commands: 'electrolyzer/bill/commands'
            }
        };

        let mqttClient = null;
        let isConnected = false;

        console.log('üèÅ PEM Dashboard Initializing...');

        // Initialize MQTT Connection
        function connectMQTT() {
            console.log('üöÄ Connecting to MQTT via WebSocket...');
            
            try {
                // Create MQTT client with proper WebSocket connection
                mqttClient = mqtt.connect(MQTT_CONFIG.broker, {
                    clientId: 'pem-dashboard-' + Math.random().toString(16).substr(2, 8),
                    clean: true,
                    connectTimeout: 4000,
                    reconnectPeriod: 2000
                });

                mqttClient.on('connect', () => {
                    console.log('‚úÖ Connected to MQTT broker!');
                    isConnected = true;
                    updateConnectionStatus('CONNECTED', true);
                    
                    // Subscribe to Arduino data
                    mqttClient.subscribe(MQTT_CONFIG.topics.data, (err) => {
                        if (!err) {
                            console.log('üëÇ Subscribed to Arduino data');
                            showNotification('Connected to Arduino!', 'success');
                        }
                    });
                });

                mqttClient.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        console.log('üì• Data received from Arduino:', data);
                        updateDashboard(data);
                        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    } catch (e) {
                        console.error('‚ùå JSON parse error:', e);
                    }
                });

                mqttClient.on('error', (error) => {
                    console.error('‚ùå MQTT error:', error);
                    isConnected = false;
                    updateConnectionStatus('ERROR', false);
                    showNotification('MQTT Connection Error', 'error');
                });

                mqttClient.on('close', () => {
                    console.log('üîå MQTT connection closed');
                    isConnected = false;
                    updateConnectionStatus('RECONNECTING...', false);
                });

                mqttClient.on('reconnect', () => {
                    console.log('üîÑ Attempting to reconnect...');
                    updateConnectionStatus('RECONNECTING...', false);
                });

            } catch (error) {
                console.error('‚ùå Connection setup error:', error);
                setTimeout(connectMQTT, 3000);
            }
        }

        // Send commands to Arduino
        function sendMQTTCommand(command, value = null) {
            if (!isConnected || !mqttClient) {
                console.log('‚ùå Not connected to Arduino');
                showNotification('Not connected to Arduino!', 'error');
                return false;
            }
            
            const message = {};
            
            // Handle different command types
            if (command === 'slider') {
                message.slider = parseInt(value);
            } else if (command === 'mode') {
                message.mode = value;
            } else if (command === 'START' || command === 'STOP') {
                message.command = command;
            }
            
            message.timestamp = new Date().toISOString();
            
            try {
                mqttClient.publish(MQTT_CONFIG.topics.commands, JSON.stringify(message));
                console.log('üì§ MQTT Command sent:', message);
                return true;
            } catch (error) {
                console.error('‚ùå Error sending command:', error);
                showNotification('Failed to send command', 'error');
                return false;
            }
        }

        // Update dashboard with Arduino data
        function updateDashboard(data) {
            console.log('üîÑ Updating dashboard with live data');
            
            // Update sensor values
            if (data.water !== undefined) {
                document.getElementById('waterVal').textContent = data.water.toFixed(1) + '%';
                updateBar('waterBar', data.water);
            }
            if (data.oxygen !== undefined) {
                document.getElementById('oxyVal').textContent = data.oxygen.toFixed(1) + '%';
                updateBar('o2Bar', data.oxygen);
            }
            if (data.hydrogen !== undefined) {
                document.getElementById('h2Val').textContent = data.hydrogen.toFixed(1) + '%';
                updateBar('h2Bar', data.hydrogen);
            }
            if (data.chamber !== undefined) {
                document.getElementById('chamberVal').textContent = data.chamber.toFixed(1) + '¬∞C';
                updateBar('tempBar', data.chamber, 100);
            }
            if (data.production !== undefined) {
                document.getElementById('prodValue').textContent = data.production + '%';
                document.getElementById('prodSlider').value = data.production;
            }
            if (data.efficiency !== undefined) {
                document.getElementById('efficiencyText').textContent = data.efficiency.toFixed(1) + '%';
            }
            if (data.battery !== undefined) {
                document.getElementById('batteryV').textContent = data.battery.toFixed(1) + ' V';
            }
            if (data.purity !== undefined) {
                document.getElementById('purityLevel').textContent = data.purity.toFixed(1) + '%';
            }
            if (data.controllerType !== undefined) {
                document.getElementById('controllerType').textContent = data.controllerType;
            }
            if (data.systemMode !== undefined) {
                document.getElementById('currentMode').textContent = data.systemMode;
            }
            if (data.systemRunning !== undefined) {
                // Update system status visually if needed
                console.log('System running:', data.systemRunning);
            }
        }

        // Update bar visualization
        function updateBar(barId, value, max = 100) {
            const bar = document.getElementById(barId);
            if (bar) {
                const percentage = Math.min((value / max) * 100, 100);
                bar.style.height = percentage + '%';
            }
        }

        // Control functions
        function setProductionRate(value) {
            console.log('üéöÔ∏è Setting production rate via MQTT:', value + '%');
            sendMQTTCommand('slider', parseInt(value));
        }

        function setMode(mode) {
            console.log('üîß Setting mode via MQTT:', mode);
            sendMQTTCommand('mode', mode);
            document.getElementById('currentMode').textContent = mode;
            showNotification('Mode set to ' + mode, 'info');
        }

        function startSystem() {
            console.log('üöÄ Starting system via MQTT');
            sendMQTTCommand('START');
            showNotification('System STARTED', 'success');
        }

        function stopSystem() {
            console.log('üõë Stopping system via MQTT');
            sendMQTTCommand('STOP');
            showNotification('System STOPPED', 'warning');
        }

        // Connection status update
        function updateConnectionStatus(status, isConnected) {
            const wifiElement = document.getElementById('wifiStatus');
            if (wifiElement) {
                wifiElement.textContent = status;
                wifiElement.style.color = isConnected ? '#4CAF50' : '#f44336';
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Dashboard initialization complete');
            
            // Setup slider event listener
            const slider = document.getElementById('prodSlider');
            if (slider) {
                slider.addEventListener('input', function(e) {
                    const value = e.target.value;
                    document.getElementById('prodValue').textContent = value + '%';
                    console.log('üéöÔ∏è Slider moved to:', value + '%');
                    setProductionRate(value);
                });
            }
            
            // Start MQTT connection
            connectMQTT();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (mqttClient) {
                mqttClient.end();
            }
        });
    </script>
</body>
</html>
