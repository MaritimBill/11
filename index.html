<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HE-NMPC Electrolyzer Control</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e88e5; --primary-dark: #1565c0; --primary-light: #64b5f6;
            --primary-gradient: linear-gradient(135deg, #1e88e5, #1565c0);
            --secondary: #546e7a; --success: #4caf50; --warning: #ff9800; --danger: #f44336;
            --card-bg: #ffffff; --light-bg: #f8fdff; --text-dark: #263238; --text-light: #607d8b;
            --border: #e3f2fd; --shadow: rgba(30, 136, 229, 0.08); --shadow-hover: rgba(30, 136, 229, 0.15);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #f8fdff 0%, #e3f2fd 100%); min-height: 100vh; }
        
        .navbar { background: var(--primary-gradient); padding: 1rem 2rem; color: white; box-shadow: 0 4px 20px rgba(13, 71, 161, 0.15); }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .brand { display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem; font-weight: 700; }
        .nav-links { display: flex; gap: 0.5rem; }
        .nav-link { padding: 0.75rem 1.25rem; color: rgba(255,255,255,0.9); text-decoration: none; border-radius: 8px; transition: all 0.3s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { text-align: center; margin-bottom: 2.5rem; }
        .page-title { font-size: 2.5rem; font-weight: 800; color: var(--text-dark); margin-bottom: 0.75rem; }
        .page-subtitle { font-size: 1.1rem; color: var(--text-light); }
        
        .status-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
        .status-card { background: var(--card-bg); border-radius: 16px; padding: 1.75rem; text-align: center; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border); transition: all 0.3s; }
        .status-card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px var(--shadow-hover); }
        .status-label { color: var(--text-light); font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem; }
        .status-value { font-size: 2rem; font-weight: 700; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: 1fr; } }
        
        .panel { background: var(--card-bg); border-radius: 20px; padding: 2rem; box-shadow: 0 4px 25px var(--shadow); border: 1px solid var(--border); transition: all 0.3s; }
        .panel:hover { transform: translateY(-2px); box-shadow: 0 8px 35px var(--shadow-hover); }
        .panel-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.75rem; padding-bottom: 1.25rem; border-bottom: 1px solid var(--border); }
        .panel-title { font-size: 1.4rem; font-weight: 700; color: var(--text-dark); }
        
        .control-group { margin-bottom: 2rem; }
        .control-label { display: block; margin-bottom: 1rem; color: var(--text-dark); font-weight: 600; }
        .slider-container { display: flex; align-items: center; gap: 1rem; margin: 1.25rem 0; }
        .slider { flex: 1; height: 8px; background: var(--border); border-radius: 10px; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 8px rgba(30,136,229,0.3); }
        .slider-value { min-width: 70px; text-align: center; font-weight: 700; color: var(--primary); }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
        .btn { padding: 1.1rem 1.5rem; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 15px rgba(30,136,229,0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(30,136,229,0.4); }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-dark); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; }
        .chart-container { background: var(--card-bg); border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border); }
        .chart-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 1.25rem; color: var(--text-dark); }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        
        .notification { position: fixed; top: 25px; right: 25px; padding: 1.25rem 1.75rem; background: white; border-radius: 14px; transform: translateX(400px); transition: all 0.4s; z-index: 1000; box-shadow: 0 8px 30px rgba(0,0,0,0.12); display: flex; align-items: center; gap: 1rem; }
        .notification.show { transform: translateX(0); }
        .notification.success { border-left: 4px solid var(--success); }
        .notification.error { border-left: 4px solid var(--danger); }
        
        @media (max-width: 768px) { 
            .container { padding: 1rem; } 
            .dashboard-grid, .chart-grid { grid-template-columns: 1fr; }
            .btn-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="brand">HE-NMPC Electrolyzer Control</div>
            <div class="nav-links">
                <a href="#" class="nav-link active" onclick="showPage('dashboard')">Dashboard</a>
                <a href="#" class="nav-link" onclick="showPage('electrolyzer')">Electrolyzer</a>
                <a href="#" class="nav-link" onclick="showPage('analytics')">Analytics</a>
            </div>
        </div>
    </nav>

    <div id="dashboard" class="page active">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">HE-NMPC Control Dashboard</h1>
                <p class="page-subtitle">Real-time PEM Electrolyzer Monitoring & Control</p>
            </div>

            <div class="status-bar">
                <div class="status-card"><div class="status-label">System Status</div><div class="status-value" style="color:var(--success)">RUNNING</div></div>
                <div class="status-card"><div class="status-label">HE-NMPC Mode</div><div class="status-value" style="color:var(--primary)">ACTIVE</div></div>
                <div class="status-card"><div class="status-label">Production Rate</div><div class="status-value" id="productionRate">42.3%</div></div>
                <div class="status-card"><div class="status-label">Efficiency</div><div class="status-value" id="efficiency">78.5%</div></div>
                <div class="status-card"><div class="status-label">Safety Margin</div><div class="status-value" id="safetyMargin">15.2%</div></div>
                <div class="status-card"><div class="status-label">Last Update</div><div class="status-value" id="lastUpdate">14:30:02</div></div>
            </div>

            <div class="dashboard-grid">
                <div class="panel">
                    <div class="panel-header"><h2 class="panel-title">Economic Control</h2></div>
                    <div class="control-group">
                        <label class="control-label">Economic Setpoint (Upper Layer)</label>
                        <div class="slider-container"><span>0%</span><input type="range" min="0" max="100" value="45" class="slider" id="economicSetpoint"><span>100%</span></div>
                        <div class="slider-value" id="economicValue">45%</div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Safety Setpoint (Lower Layer)</label>
                        <div class="slider-container"><span>0%</span><input type="range" min="0" max="100" value="42" class="slider" id="safetySetpoint" disabled><span>100%</span></div>
                        <div class="slider-value" id="safetyValue">42%</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="sendUpperLayerCommand('RUN_OPTIMIZATION')">RUN OPTIMIZATION</button>
                        <button class="btn btn-outline" onclick="sendLowerLayerCommand('CALIBRATE_SENSORS')">CALIBRATE SENSORS</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header"><h2 class="panel-title">Process Overview</h2></div>
                    <div class="chart-wrapper"><canvas id="processChart"></canvas></div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">MPC Performance Comparison</div>
                    <div class="chart-wrapper"><canvas id="performanceChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Financial Performance</div>
                    <div class="chart-wrapper"><canvas id="financialChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Cost Distribution</div>
                    <div class="chart-wrapper"><canvas id="costChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Efficiency Trends</div>
                    <div class="chart-wrapper"><canvas id="efficiencyChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="electrolyzer" class="page">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Electrolyzer Detailed View</h1>
                <p class="page-subtitle">Real-time Process Parameters</p>
            </div>
            <!-- Additional electrolyzer content -->
        </div>
    </div>

    <div id="analytics" class="page">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Performance Analytics</h1>
                <p class="page-subtitle">HE-NMPC vs Other Methods</p>
            </div>
            <!-- Additional analytics content -->
        </div>
    </div>

    <div class="notification" id="notification">
        <span id="notificationText">HE-NMPC System Ready</span>
    </div>

    <script>
        // Configuration
        const MQTT_CONFIG = {
            broker: 'wss://broker.hivemq.com:8884/mqtt',
            topics: { 
                data: 'electrolyzer/bill/data', 
                upper_commands: 'electrolyzer/bill/upper_commands', 
                lower_commands: 'electrolyzer/bill/lower_commands' 
            }
        };

        let mqttClient = null, isConnected = false, charts = {};

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        // Initialize Charts
        function initializeCharts() {
            // Process Overview Chart
            charts.processChart = new Chart(document.getElementById('processChart'), {
                type: 'line',
                data: {
                    labels: Array.from({length: 20}, (_, i) => `${i}s`),
                    datasets: [{
                        label: 'Production Rate',
                        data: Array.from({length: 20}, () => Math.random() * 20 + 40),
                        borderColor: '#1e88e5',
                        backgroundColor: 'rgba(30, 136, 229, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, min: 30, max: 70,
                            grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Performance Comparison Chart
            charts.performanceChart = new Chart(document.getElementById('performanceChart'), {
                type: 'bar',
                data: {
                    labels: ['HE-NMPC', 'Stochastic MPC', 'Mixed-Integer MPC', 'Standard MPC'],
                    datasets: [{
                        label: 'Performance Score',
                        data: [94, 87, 82, 76],
                        backgroundColor: [
                            'rgba(30, 136, 229, 0.8)',
                            'rgba(84, 110, 122, 0.6)',
                            'rgba(84, 110, 122, 0.6)',
                            'rgba(84, 110, 122, 0.6)'
                        ],
                        borderColor: [
                            'rgb(30, 136, 229)',
                            'rgb(84, 110, 122)',
                            'rgb(84, 110, 122)',
                            'rgb(84, 110, 122)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100,
                            title: { display: true, text: 'Performance (%)' } }
                    }
                }
            });

            // Financial Performance Chart
            charts.financialChart = new Chart(document.getElementById('financialChart'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [
                        {
                            label: 'HE-NMPC Cost',
                            data: [185, 172, 168, 158, 152, 142],
                            borderColor: '#1e88e5',
                            backgroundColor: 'rgba(30, 136, 229, 0.1)',
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: 'Standard MPC Cost',
                            data: [210, 205, 198, 192, 188, 185],
                            borderColor: '#546e7a',
                            backgroundColor: 'rgba(84, 110, 122, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: false,
                            title: { display: true, text: 'Daily Cost ($)' }
                        }
                    }
                }
            });

            // Cost Distribution Pie Chart
            charts.costChart = new Chart(document.getElementById('costChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Electricity', 'Maintenance', 'Water', 'Other'],
                    datasets: [{
                        data: [65, 15, 12, 8],
                        backgroundColor: [
                            'rgba(30, 136, 229, 0.8)',
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(3, 169, 244, 0.8)',
                            'rgba(255, 152, 0, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Efficiency Trends Chart
            charts.efficiencyChart = new Chart(document.getElementById('efficiencyChart'), {
                type: 'line',
                data: {
                    labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                    datasets: [{
                        label: 'Efficiency',
                        data: [75, 78, 82, 79, 76, 74],
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, min: 70, max: 90 }
                    }
                }
            });
        }

        // MQTT Functions
        function connectMQTT() {
            try {
                mqttClient = mqtt.connect(MQTT_CONFIG.broker, {
                    clientId: 'he-nmpc-dashboard-' + Math.random().toString(16).substr(2, 8)
                });

                mqttClient.on('connect', () => {
                    isConnected = true;
                    showNotification('HE-NMPC System Connected', 'success');
                    mqttClient.subscribe(MQTT_CONFIG.topics.data);
                });

                mqttClient.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        updateAllDisplays(data);
                        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    } catch (e) { console.error('JSON parse error:', e); }
                });

            } catch (error) { console.error('Connection error:', error); }
        }

        function sendUpperLayerCommand(command) {
            if (!isConnected) { showNotification('Upper layer not connected', 'error'); return; }
            const message = { command: command, layer: 'UPPER', timestamp: new Date().toISOString() };
            mqttClient.publish(MQTT_CONFIG.topics.upper_commands, JSON.stringify(message));
            showNotification('Python optimization started', 'success');
        }

        function sendLowerLayerCommand(command) {
            if (!isConnected) { showNotification('Lower layer not connected', 'error'); return; }
            const message = { command: command, layer: 'LOWER', timestamp: new Date().toISOString() };
            mqttClient.publish(MQTT_CONFIG.topics.lower_commands, JSON.stringify(message));
            showNotification('Arduino safety MPC active', 'success');
        }

        // Update displays
        function updateAllDisplays(data) {
            if (data.production !== undefined) {
                document.getElementById('productionRate').textContent = data.production.toFixed(1) + '%';
                document.getElementById('safetyValue').textContent = data.production.toFixed(1) + '%';
                document.getElementById('safetySetpoint').value = data.production;
            }
            if (data.efficiency !== undefined) document.getElementById('efficiency').textContent = data.efficiency.toFixed(1) + '%';
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            text.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            connectMQTT();
            
            // Setup slider events
            document.getElementById('economicSetpoint').addEventListener('input', function(e) {
                const value = e.target.value;
                document.getElementById('economicValue').textContent = value + '%';
                if (isConnected) {
                    const message = { 
                        command: 'SET_SETPOINT', 
                        value: parseFloat(value),
                        layer: 'UPPER', 
                        timestamp: new Date().toISOString() 
                    };
                    mqttClient.publish(MQTT_CONFIG.topics.upper_commands, JSON.stringify(message));
                }
            });

            // Simulate real-time data updates
            setInterval(() => {
                if (charts.processChart) {
                    const chart = charts.processChart;
                    if (chart.data.datasets[0].data.length >= 20) {
                        chart.data.datasets[0].data.shift();
                    }
                    chart.data.datasets[0].data.push(Math.random() * 20 + 40);
                    chart.update('none');
                }
            }, 1000);
        });
    </script>
</body>
</html>
